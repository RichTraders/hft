[strategy]
algorithm = maker
allow_simultaneous_positions = false

# ==========================================
# 심볼: XRPUSDC (바이낸스 USDC 선물)
# 타겟: Low Liquidity + High Accuracy (0.15 OBI)
# ==========================================

[wall_detection]
# 호가가 얇으므로 탐색 범위를 조금 넓게 설정 (0.3%)
max_distance_pct = 0.0030
max_levels = 100

[wall_defense]
# --- 거래량/호가 기준 (USDC 유동성 고려) ---
# 유동성이 적으므로 3배만 튀어도 벽으로 인정
volume_ema_alpha = 0.05
volume_multiplier = 3.0
volume_min_samples = 20

orderbook_top_levels = 20
orderbook_multiplier = 3.0
orderbook_percentile = 85

# 가중치
volume_weight = 0.7
orderbook_weight = 0.3

# --- 최소 벽 수량 (USDC 기준) ---
# 분당 거래량(2.7만)의 약 절반 수준
min_quantity = 15000.0

# 방어 계수
qty_multiplier = 2.0

# ==========================================
# 다중 시간축 분석 (Multi-Timeframe Analysis)
# ==========================================

# === Fast Timeframe (10 ticks, ~1초) ===
# 단기 노이즈 감지
[robust_zscore_fast]
window_size = 10
min_samples = 8
entry_threshold = 2.0
min_mad_threshold = 0.0120
baseline_window = 100
min_vol_scalar = 0.7
max_vol_scalar = 1.3
vol_ratio_low = 0.5
vol_ratio_high = 2.0
baseline_min_history = 30

# === Mid Timeframe (30 ticks, ~5초) ===
# 기존 전략, 진입 타이밍 결정
[robust_zscore]
window_size = 30
min_samples = 20
entry_threshold = 2.0

# CRITICAL FIX: 0.0001 was 446x too low, causing extreme Z-scores in ranging markets
# XRP $2.0 기준: 0.0120 = 약 $0.018 std dev (0.9%)
# 30-tick MAD 추정치: $0.0081 (6-sigma range ~$0.09)
# 횡보장 시 극단적 Z-score 방지 (±10, ±20 신호 차단)
min_mad_threshold = 0.0120

# === 변동성 적응형 임계값 (Volatility-Adaptive Thresholds) ===
# 기준선 MAD 계산 윈도우 (최근 N개 MAD 값의 평균)
baseline_window = 100

# 최소 변동성 스케일러 (저변동성 시장)
# vol_ratio < 0.5일 때: 낮은 임계값으로 작은 움직임도 포착
min_vol_scalar = 0.7

# 최대 변동성 스케일러 (고변동성 시장)
# vol_ratio > 2.0일 때: 높은 임계값으로 노이즈 회피
max_vol_scalar = 1.3

# 변동성 비율 임계값 (adaptive scaling 계산용)
vol_ratio_low = 0.5    # 저변동성 기준 (이하면 min_vol_scalar 적용)
vol_ratio_high = 2.0   # 고변동성 기준 (이상이면 max_vol_scalar 적용)

# MAD 기준선 계산 최소 이력
baseline_min_history = 30  # 최소 30개 MAD 값 필요

# === Slow Timeframe (100 ticks, ~30초) ===
# 장기 트렌드 필터 (핵심!)
[robust_zscore_slow]
window_size = 100
min_samples = 60
entry_threshold = 1.5    # 더 완화된 임계값 (트렌드 감지용)
min_mad_threshold = 0.0120
baseline_window = 100
min_vol_scalar = 0.7
max_vol_scalar = 1.3
vol_ratio_low = 0.5
vol_ratio_high = 2.0
baseline_min_history = 30

[mean_reversion]
# 반전 감지를 위한 최소 반등 폭
min_reversal_bounce = 0.2

# 중립 영역 복귀 임계값
neutral_zone_threshold = 1.0

# === 5-State Phase Tracking (상대적 임계값) ===
# NEUTRAL → BUILDING_OVERSOLD 진입
# |z| > neutral_zone_threshold * building_multiplier
building_multiplier = 1.0

# BUILDING_OVERSOLD → DEEP_OVERSOLD 진입
# |z| > adaptive_threshold * deep_multiplier
deep_multiplier = 1.2

# DEEP_OVERSOLD → REVERSAL_WEAK 진입
# |z| < adaptive_threshold * reversal_weak_multiplier (반등 후)
reversal_weak_multiplier = 0.8

# REVERSAL_WEAK → REVERSAL_STRONG 진입 (진입 가능 상태)
# |z| < adaptive_threshold * reversal_strong_multiplier
reversal_strong_multiplier = 0.6

# 거짓 반전 감지 (REVERSAL_WEAK → DEEP_OVERSOLD 전환)
# 반등 후 다시 하락 시 거짓 반전으로 판단하는 기준
# min_reversal_bounce의 배수로 계산 (0.5 = 50% 하락 시)
false_reversal_ratio = 0.5

[entry]
# [작성자님 피드백 반영]
# 0.45는 속임수가 많음 -> 0.15로 '확실한 반등'만 타격
# 매도세가 진정되고 호가가 균형(-0.15)을 찾을 때 진입
obi_threshold = 0.4
# OBI 계산 깊이 - wall_defense(20)와 동일, 스푸핑 방지
obi_levels = 20

# 포지션 사이즈 (테스트)
position_size = 3.0
safety_margin = 0.0001

# ==========================================
# Multi-Factor Scoring (다중 요인 점수화)
# ==========================================
# 최소 복합 신호 품질 (0.65 = GOOD 이상만 진입)
# 0.8+ = EXCELLENT, 0.65+ = GOOD, 0.5+ = MARGINAL, <0.5 = POOR
min_signal_quality = 0.65

# === Signal Component Weights (가중치 합계 = 1.0) ===
# Z-score 강도 가중치 (가장 중요)
zscore_weight = 0.35

# 벽 강도 가중치 (두 번째로 중요)
wall_weight = 0.30

# 거래량 반전 강도 가중치
volume_weight = 0.20

# OBI 정렬 강도 가중치
obi_weight = 0.15

# === Normalization Parameters (정규화 파라미터) ===
# Z-score 정규화: |z|가 이 범위 내에 있을 때 0~1로 매핑
# 예: z=-2.0 → 0.0, z=-3.0 → 1.0
zscore_norm_min = 2.0   # 최소 임계값
zscore_norm_max = 3.0   # 최대 임계값

# 벽 정규화: wall_qty / (min_quantity * wall_norm_multiplier)
# 예: min_quantity=15000, multiplier=2.0 → 30000 이상이면 1.0
wall_norm_multiplier = 2.0

# OBI 정규화: |OBI|가 이 범위 내에 있을 때 0~1로 매핑
# 예: OBI=-0.05 → 0.0, OBI=-0.25 → 1.0
obi_norm_min = 0.05
obi_norm_max = 0.25

# 거래량 분석 윈도우 (최근 N틱의 방향성 분석)
volume_score_lookback = 5

[exit]
# 시간 기반 청산 사용 여부
enabled = false

# === 능동적 청산 (Active Exit - Profit Taking) ===
# Z-score 회귀 청산 (진입: -2.0 → 청산: -0.5)
zscore_exit_threshold = 0.5

# OBI 반전 청산 (XRP는 더 엄격하게 40%)
obi_exit_threshold = 0.7

# === 수동적 청산 (Passive Exit - Safety Net) ===
# 얇은 호가창 특성상 벽 기준 완화
wall_amount_decay_ratio = 0.6    # 60% (BTC는 50%)
wall_distance_expand_ratio = 2.5 # 2.5배 (BTC는 1.2배)
max_loss_pct = 0.0015            # 0.15% (BTC는 0.2%)
max_hold_time_sec = 5.0

# ==========================================
# 역선택 탐지 (Adverse Selection Detection)
# ==========================================
[adverse_selection]
# 체결 이력 추적 개수
max_fill_history = 20

# 측정 시간 윈도우 (나노초) - 1초 ± 100ms
measurement_window_ns = 1000000000
measurement_tolerance_ns = 100000000

# Adverse 판단 임계값 (0.02%)
# 롱 체결 후 -0.02% 이상 하락 = Adverse
# 숏 체결 후 +0.02% 이상 상승 = Adverse
adverse_threshold_pct = 0.0002

# 최소 측정 샘플 (이하면 판단 안함)
min_samples = 10

# Adverse 비율 임계값 (50% 이상이면 경고)
ratio_threshold = 0.5

# 대응: safety_margin 확대 배수
margin_multiplier = 1.5

[debug]
log_wall_detection = true
log_defense_check = true
log_entry_exit = true