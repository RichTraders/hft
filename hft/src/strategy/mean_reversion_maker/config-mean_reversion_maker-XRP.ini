# ==========================================
# 심볼: XRPUSDC (바이낸스 USDC 선물)
# 타겟: Low Liquidity + High Accuracy (0.15 OBI)
# ==========================================

[wall_detection]
# 호가가 얇으므로 탐색 범위를 조금 넓게 설정 (0.3%)
max_distance_pct = 0.0030
max_levels = 100

[wall_defense]
# --- 거래량/호가 기준 (USDC 유동성 고려) ---
# 유동성이 적으므로 2.5배만 튀어도 벽으로 인정 (더 완화)
volume_ema_alpha = 0.05
volume_multiplier = 2.5
volume_min_samples = 15

orderbook_top_levels = 20
orderbook_multiplier = 2.5
orderbook_percentile = 80

# 가중치
volume_weight = 0.7
orderbook_weight = 0.3

# --- 최소 벽 수량 (USDC 기준) ---
# 분당 거래량(2.7만)의 약 절반 수준
# 저유동성: 8000으로 대폭 완화
min_quantity = 8000.0

# 방어 계수
qty_multiplier = 2.0

# ==========================================
# 다중 시간축 분석 (Multi-Timeframe Analysis)
# ==========================================

# === 공통 파라미터 (All Timeframes) ===
# CRITICAL FIX: 0.0001 was 446x too low, causing extreme Z-scores in ranging markets
# XRP $2.0 기준: 0.0120 = 약 $0.018 std dev (0.9%)
# 횡보장 시 극단적 Z-score 방지 (±10, ±20 신호 차단)
[robust_zscore_common]
min_mad_threshold = 0.0120
baseline_window = 100
min_vol_scalar = 0.7
max_vol_scalar = 1.3
vol_ratio_low = 0.5
vol_ratio_high = 2.0
baseline_min_history = 30

# === Fast Timeframe (10 ticks, ~1초) ===
[robust_zscore_fast]
window_size = 10
min_samples = 8
entry_threshold = 2.0

# === Mid Timeframe (30 ticks, ~5초) ===
[robust_zscore]
window_size = 30
min_samples = 20
entry_threshold = 1.5

# === Slow Timeframe (100 ticks, ~30초) ===
[robust_zscore_slow]
window_size = 100
min_samples = 60
entry_threshold = 1.5

[mean_reversion]
# 반전 감지를 위한 최소 반등 폭
min_reversal_bounce = 0.2

# 중립 영역 복귀 임계값
neutral_zone_threshold = 1.0

# === 5-State Phase Tracking (상대적 임계값) ===
# NEUTRAL → BUILDING_OVERSOLD 진입
# |z| > neutral_zone_threshold * building_multiplier
building_multiplier = 1.0

# BUILDING_OVERSOLD → DEEP_OVERSOLD 진입
# |z| > adaptive_threshold * deep_multiplier
deep_multiplier = 1.2

# DEEP_OVERSOLD → REVERSAL_WEAK 진입
# |z| < adaptive_threshold * reversal_weak_multiplier (반등 후)
reversal_weak_multiplier = 0.8

# REVERSAL_WEAK → REVERSAL_STRONG 진입 (진입 가능 상태)
# |z| < adaptive_threshold * reversal_strong_multiplier
reversal_strong_multiplier = 0.6

# 거짓 반전 감지 (REVERSAL_WEAK → DEEP_OVERSOLD 전환)
# 반등 후 다시 하락 시 거짓 반전으로 판단하는 기준
# min_reversal_bounce의 배수로 계산 (0.5 = 50% 하락 시)
false_reversal_ratio = 0.5

# ==========================================
# 역선택 탐지 (Adverse Selection Detection)
# ==========================================
[adverse_selection]
# 체결 이력 추적 개수
max_fill_history = 20

# 측정 시간 윈도우 (나노초) - 1초 ± 100ms
measurement_window_ns = 1000000000
measurement_tolerance_ns = 100000000

# Adverse 판단 임계값 (0.02%)
# 롱 체결 후 -0.02% 이상 하락 = Adverse
# 숏 체결 후 +0.02% 이상 상승 = Adverse
adverse_threshold_pct = 0.0002

# 최소 측정 샘플 (이하면 판단 안함)
min_samples = 10

# Adverse 비율 임계값 (50% 이상이면 경고)
ratio_threshold = 0.5

# 대응: safety_margin 확대 배수
margin_multiplier = 1.5

[entry]
# [작성자님 피드백 반영]
# 0.45는 속임수가 많음 -> 0.15로 '확실한 반등'만 타격
# 매도세가 진정되고 호가가 균형(-0.15)을 찾을 때 진입
# 저유동성 시장: 0.3으로 완화
obi_threshold = 0.3
# OBI 계산 깊이 - wall_defense(20)와 동일, 스푸핑 방지
obi_levels = 20

# 포지션 사이즈 (테스트)
position_size = 3.0
safety_margin = 0.0001

# ==========================================
# Multi-Factor Scoring (다중 요인 점수화)
# ==========================================
# 최소 복합 신호 품질 (0.65 = GOOD 이상만 진입)
# 0.8+ = EXCELLENT, 0.65+ = GOOD, 0.5+ = MARGINAL, <0.5 = POOR
# 저유동성: 0.55로 완화 (MARGINAL 허용)
min_signal_quality = 0.55

# === Signal Component Weights (가중치 합계 = 1.0) ===
# Z-score 강도 가중치 (가장 중요)
zscore_weight = 0.35

# 벽 강도 가중치 (두 번째로 중요)
wall_weight = 0.30

# 거래량 반전 강도 가중치
volume_weight = 0.20

# OBI 정렬 강도 가중치
obi_weight = 0.15

# === Normalization Parameters (정규화 파라미터) ===
# Z-score 정규화: |z|가 이 범위 내에 있을 때 0~1로 매핑
# 예: z=-2.0 → 0.0, z=-3.0 → 1.0
zscore_norm_min = 2.0   # 최소 임계값
zscore_norm_max = 3.0   # 최대 임계값

# 벽 정규화: wall_qty / (min_quantity * wall_norm_multiplier)
# 예: min_quantity=15000, multiplier=2.0 → 30000 이상이면 1.0
wall_norm_multiplier = 2.0

# OBI 정규화: |OBI|가 이 범위 내에 있을 때 0~1로 매핑
# 예: OBI=-0.05 → 0.0, OBI=-0.25 → 1.0
obi_norm_min = 0.05
obi_norm_max = 0.25

# 거래량 분석 윈도우 (최근 N틱의 방향성 분석)
volume_score_lookback = 5

# SHORT 진입 시 Z-score 최소 유지 비율
# 과매수 임계값(+2.0)의 80% 이상 유지해야 진입 허용
# 예: +2.0 → +1.6 이하로 떨어지면 진입 차단
short_zscore_min_ratio = 0.8

# ==========================================
# 시장 체제 탐지 (Market Regime Detection)
# ==========================================
[market_regime]
# 고변동성 판단 임계값 (2.0 = MAD가 평균의 2배)
high_vol_threshold = 2.0

# 추세 판단 Z-score 임계값 (±1.5)
# 연속된 Z-score가 모두 이 값 초과/미만이면 추세로 판단
trend_threshold = 1.5

# 추세 판단을 위한 연속 Z-score 개수
trend_history_size = 3

[exit]
# === Active Exit Thresholds ===
# Z-score 회귀 청산 (진입: -2.0 → 청산: -0.5)
zscore_exit_threshold = 0.5

# OBI 반전 청산 (진입 0.3과 갭 0.15 유지)
obi_exit_threshold = 0.45  # 진입 0.3와 갭 0.15

# === Passive Exit (Safety Net) ===
# 벽 수량 감소 (60% → 70%)
wall_amount_decay_ratio = 0.7

# 벽 거리 확대 (2.5배 → 2.0배)
wall_distance_expand_ratio = 2.0

# 손절 (0.15% → 0.20%)
max_loss_pct = 0.0020

# 시간 제한 (5초 → 30초)
max_hold_time_sec = 30.0

# === Multi-Factor Exit Scoring ===
# 최소 복합 청산 점수 (0.65 = MEDIUM urgency)
min_exit_quality = 0.65

# Component weights (합계 = 1.0)
z_reversion_weight = 0.40   # 40% (가장 중요)
obi_reversal_weight = 0.30  # 30%
wall_decay_weight = 0.20    # 20%
time_weight = 0.10          # 10%

# Soft time limit ratio (50% of max_hold_time)
# 15초에서 pressure=0.5
soft_time_ratio = 0.5

# Override mode: lower exit threshold for risky entries
override_exit_threshold = 0.5

# Urgency classification thresholds
urgency_high_threshold = 0.8
urgency_low_threshold = 0.5

[debug]
log_wall_detection = true
log_defense_check = true
log_entry_exit = true