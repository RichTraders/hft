[strategy]
algorithm = maker
allow_simultaneous_positions = false

# ==========================================
# 심볼: XRPUSDC (바이낸스 USDC 선물)
# 타겟: Low Liquidity + High Accuracy (0.15 OBI)
# ==========================================

[wall_detection]
# 호가가 얇으므로 탐색 범위를 조금 넓게 설정 (0.3%)
max_distance_pct = 0.0030
max_levels = 100

[wall_defense]
threshold_mode = hybrid

# --- 거래량/호가 기준 (USDC 유동성 고려) ---
# 유동성이 적으므로 3배만 튀어도 벽으로 인정
volume_ema_alpha = 0.05
volume_multiplier = 3.0
volume_min_samples = 20

orderbook_top_levels = 20
orderbook_multiplier = 3.0
orderbook_percentile = 85

# 가중치
volume_weight = 0.7
orderbook_weight = 0.3

# --- 최소 벽 수량 (USDC 기준) ---
# 분당 거래량(2.7만)의 약 절반 수준
min_quantity = 15000.0

# 방어 계수
qty_multiplier = 2.0

[robust_zscore]
window_size = 30
min_samples = 20
entry_threshold = 2.0

# CRITICAL FIX: 0.0001 was 446x too low, causing extreme Z-scores in ranging markets
# XRP $2.0 기준: 0.0120 = 약 $0.018 std dev (0.9%)
# 30-tick MAD 추정치: $0.0081 (6-sigma range ~$0.09)
# 횡보장 시 극단적 Z-score 방지 (±10, ±20 신호 차단)
min_mad_threshold = 0.0120

# === 변동성 적응형 임계값 (Volatility-Adaptive Thresholds) ===
# 기준선 MAD 계산 윈도우 (최근 N개 MAD 값의 평균)
baseline_window = 100

# 최소 변동성 스케일러 (저변동성 시장)
# vol_ratio < 0.5일 때: 낮은 임계값으로 작은 움직임도 포착
min_vol_scalar = 0.7

# 최대 변동성 스케일러 (고변동성 시장)
# vol_ratio > 2.0일 때: 높은 임계값으로 노이즈 회피
max_vol_scalar = 1.3

# 변동성 비율 임계값 (adaptive scaling 계산용)
vol_ratio_low = 0.5    # 저변동성 기준 (이하면 min_vol_scalar 적용)
vol_ratio_high = 2.0   # 고변동성 기준 (이상이면 max_vol_scalar 적용)

# MAD 기준선 계산 최소 이력
baseline_min_history = 30  # 최소 30개 MAD 값 필요

[trend_filter]
enabled = true
# 추세 가속 감지 윈도우 (reversal_momentum보다 짧게)
lookback_ticks = 10
# 최소 연속 동일 방향 틱 (10틱 중 6틱 = 60%)
consecutive_threshold = 6
# 거래량 가속 배수 (최근 vs 이전)
volume_multiplier = 2.0

[reversal_momentum]
# 반전 모멘텀 확인 (매수 줄고 매도 앞서는 순간 감지)
enabled = true
# 최근 N틱 분석
lookback_ticks = 20
# 최소 동일 방향 틱 수 (20틱 중 10틱 = 50%)
min_directional_ticks = 10
# 거래량 비율 (매도량 / 매수량, 1.3 = 30% 더 많음)
min_volume_ratio = 1.3

[mean_reversion]
# 평균회귀 추세 추적 (DEPRECATED - 호환성 유지)
oversold_start_threshold = 1.5
overbought_start_threshold = 1.5
min_reversal_bounce = 0.2
neutral_zone_threshold = 1.0

# === 5-State Phase Tracking (상대적 임계값) ===
# NEUTRAL → BUILDING_OVERSOLD 진입
# |z| > neutral_zone_threshold * building_multiplier
building_multiplier = 1.0

# BUILDING_OVERSOLD → DEEP_OVERSOLD 진입
# |z| > adaptive_threshold * deep_multiplier
deep_multiplier = 1.2

# DEEP_OVERSOLD → REVERSAL_WEAK 진입
# |z| < adaptive_threshold * reversal_weak_multiplier (반등 후)
reversal_weak_multiplier = 0.8

# REVERSAL_WEAK → REVERSAL_STRONG 진입 (진입 가능 상태)
# |z| < adaptive_threshold * reversal_strong_multiplier
reversal_strong_multiplier = 0.6

# 거짓 반전 감지 (REVERSAL_WEAK → DEEP_OVERSOLD 전환)
# 반등 후 다시 하락 시 거짓 반전으로 판단하는 기준
# min_reversal_bounce의 배수로 계산 (0.5 = 50% 하락 시)
false_reversal_ratio = 0.5

[entry]
# [작성자님 피드백 반영]
# 0.45는 속임수가 많음 -> 0.15로 '확실한 반등'만 타격
# 매도세가 진정되고 호가가 균형(-0.15)을 찾을 때 진입
obi_threshold = 0.4
# OBI 계산 깊이 - wall_defense(20)와 동일, 스푸핑 방지
obi_levels = 20

# 포지션 사이즈 (테스트)
position_size = 3.0
safety_margin = 0.0001
min_spread_filter = 0.0

[exit]
# 시간 기반 청산 사용 여부
enabled = false

# === 능동적 청산 (Active Exit - Profit Taking) ===
# Z-score 회귀 청산 (진입: -2.0 → 청산: -0.5)
zscore_exit_threshold = 0.5

# OBI 반전 청산 (XRP는 더 엄격하게 40%)
obi_exit_threshold = 0.7

# 거래량 반전 청산
reversal_momentum_exit = true
exit_lookback_ticks = 10
exit_min_directional_ticks = 7   # 70%
exit_min_volume_ratio = 1.5      # 1.5배

# === 수동적 청산 (Passive Exit - Safety Net) ===
# 얇은 호가창 특성상 벽 기준 완화
wall_amount_decay_ratio = 0.6    # 60% (BTC는 50%)
wall_distance_expand_ratio = 2.5 # 2.5배 (BTC는 1.2배)
max_loss_pct = 0.0015            # 0.15% (BTC는 0.2%)
max_hold_time_sec = 5.0

[debug]
log_wall_detection = true
log_defense_check = true
log_entry_exit = true