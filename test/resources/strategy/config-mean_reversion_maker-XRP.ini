# ==========================================
# 심볼: XRPUSDC (바이낸스 USDC 선물)
# 타겟: Low Liquidity + High Accuracy (0.15 OBI)
# ==========================================

[normalization]
# Entry와 Exit에서 공통으로 사용하는 정규화 파라미터
obi_max_range = 1.0         # OBI 정규화 최대값 (1.0 = kObiScale = 10000)

[wall_detection]
# 호가가 얇으므로 탐색 범위를 조금 넓게 설정 (0.3%)
max_distance_pct = 0.0030
max_levels = 100

[wall_defense]
# --- 거래량/호가 기준 (USDC 유동성 고려) ---
# 유동성이 적으므로 2.0배만 튀어도 벽으로 인정 (매매 빈도 증가)
volume_ema_alpha = 0.05
volume_multiplier = 2.0
volume_min_samples = 15

orderbook_top_levels = 20
orderbook_multiplier = 2.0
orderbook_percentile = 80

# 가중치
volume_weight = 0.7
orderbook_weight = 0.3

# --- 최소 벽 수량 (USDC 기준) ---
# 분당 거래량(9만)의 약 7.8% 수준
# HFT 빈도 증가: 7000으로 완화하여 더 많은 진입 기회 포착
min_quantity = 7000.0

# 방어 계수
qty_multiplier = 2.0

# ==========================================
# 다중 시간축 분석 (Multi-Timeframe Analysis)
# ==========================================

# === 공통 파라미터 (All Timeframes) ===
# CRITICAL FIX: 틱 단위 변동성에 맞춰 조정
# XRP $2.07 기준: 0.0001 = 약 $0.0002 (1틱 = 0.0001)
# 틱 단위 Z-score 계산 활성화
[robust_zscore_common]
min_mad_threshold = 0.0001
baseline_window = 100
min_vol_scalar = 0.7
max_vol_scalar = 1.3
vol_ratio_low = 0.5
vol_ratio_high = 2.0
baseline_min_history = 30

# === Fast Timeframe (7 ticks) ===
[robust_zscore_fast]
window_size = 7
min_samples = 5
entry_threshold = 0.5        # 5000 (횡보 필터링)

# === Mid Timeframe (14 ticks) - Primary timeframe ===
[robust_zscore_mid]
window_size = 14
min_samples = 10
entry_threshold = 0.8        # 8000 (횡보 구간 필터링 강화)

# === Slow Timeframe (21 ticks) ===
[robust_zscore_slow]
window_size = 21
min_samples = 15
entry_threshold = 1.40        # 14000 (실제 로그 z_slow:-13513 기준)

[mean_reversion]
# 반전 감지를 위한 최소 반등 폭 (Z-score 단위)
# entry_threshold(0.5)의 40% = 0.2
min_reversal_bounce = 0.2

# 중립 영역 복귀 임계값 (Z-score 단위)
# 횡보 구간 필터링 강화: 0.6으로 상향
# z_mid > 0.6 (6000)에서 Phase 1 (BUILDING) 진입
neutral_zone_threshold = 0.6

# === 5-State Phase Tracking (상대적 임계값) ===
# NEUTRAL → BUILDING_OVERSOLD 진입
# |z| > neutral_zone_threshold * building_multiplier
building_multiplier = 1.0

# BUILDING_OVERSOLD → DEEP_OVERSOLD 진입
# |z| > adaptive_threshold * deep_multiplier
deep_multiplier = 1.2

# DEEP_OVERSOLD → WEAK 진입 (Phase 2 → 3)
# |z| < adaptive_threshold * reversal_weak_multiplier (압력 약화)
reversal_weak_multiplier = 0.8

# WEAK → VERY_WEAK 진입 (Phase 3 → 4, 진입 가능 상태)
# |z| < adaptive_threshold * reversal_strong_multiplier (압력 거의 없음)
reversal_strong_multiplier = 0.9

# 거짓 반전 감지 (WEAK → DEEP_OVERSOLD 전환)
# 반등 후 다시 하락 시 거짓 반전으로 판단하는 기준
# min_reversal_bounce의 배수로 계산 (0.5 = 50% 하락 시)
false_reversal_ratio = 0.5

# ==========================================
# 역선택 탐지 (Adverse Selection Detection)
# ==========================================
[adverse_selection]
# 체결 이력 추적 개수
max_fill_history = 20

# 측정 시간 윈도우 (나노초) - 1초 ± 100ms
measurement_window_ns = 1000000000
measurement_tolerance_ns = 100000000

# Adverse 판단 임계값 (0.02%)
# 롱 체결 후 -0.02% 이상 하락 = Adverse
# 숏 체결 후 +0.02% 이상 상승 = Adverse
adverse_threshold_pct = 0.0002

# 최소 측정 샘플 (이하면 판단 안함)
min_samples = 10

# Adverse 비율 임계값 (50% 이상이면 경고)
ratio_threshold = 0.5

# 대응: safety_margin 확대 배수
margin_multiplier = 1.5

[entry]
obi_threshold = 0.15
obi_levels = 20

# 포지션 사이즈 (프로덕션)
position_size = 3

# 진입 시 안전 마진 (가격 슬리피지 보호)
safety_margin_entry = 0.0001

# Defense 검증: Phase 4에서 허용 가격 변동 범위
# XRP 변동성 고려: 0.0005 = 5틱 허용 (2틱 기본값에서 완화)
defense_max_price_slippage = 0.0005

# ==========================================
# Multi-Factor Entry Scoring (다중 요인 점수화)
# ==========================================
# Phase tracking이 z-score 타이밍 판단, signal scoring은 wall + obi만 평가

# 최소 복합 진입 품질 (wall과 obi 둘 다 균형있게 좋아야 진입)
min_signal_quality = 0.55

# Component weights (z-score 제거, 합계 = 1.0)
wall_weight = 0.60          # 60% - 지지/저항 강도
obi_weight = 0.40           # 40% - 매수/매도 압력 (중립에 가까울수록 높은 점수)

# OBI normalization (반전: 중립에 가까울수록 높은 점수)
obi_norm_min = 0.0          # 중립 시작점
obi_norm_max = 0.15         # 진입 threshold와 일치

# Wall normalization (min_quantity의 3배 크기에서 만점, 변별력 강화)
wall_norm_multiplier = 3.0

[exit]
# 청산 시 안전 마진 (가격 슬리피지 보호)
safety_margin_exit = 0.0001

# === Active Exit Thresholds ===
# Note: Multi-timeframe alignment uses Entry thresholds (Fast=0.50, Mid=0.80, Slow=1.40)
# OBI 반전 청산 (진입 완화에 맞춰 청산도 완화)
# 0.15 → 0.25 (더 확실한 반전 신호 대기)
obi_exit_threshold = 0.25

# === Passive Exit (Safety Net) ===
# 벽 수량 감소 (60% → 70%)
wall_amount_decay_ratio = 0.7

# 벽 거리 확대 (2.5배 → 2.0배)
wall_distance_expand_ratio = 2.0

# 손절 (0.15% → 0.30%, 변동성 4.6% 고려)
max_loss_pct = 0.0070

# 시간 제한 (0 = 비활성화)
# 시간 압력만으로 청산되는 것을 방지하기 위해 비활성화
# OBI 반전 또는 벽 감소가 발생해야 청산되도록 함
max_hold_time_sec = 0

# === Multi-Factor Exit Scoring ===
# 최소 복합 청산 점수
# 시간 압력 제거 후: z_reversion + obi_reversal 조합으로 청산
# z_reversion(4000) + obi_reversal(3000) = 7000 (충분)
# 0.50으로 설정 → 5000 이상이면 청산 (단일 요소만으로도 가능)
min_exit_quality = 0.50


wall_decay_weight = 0.6
obi_reversal_weight = 0.4
time_weight = 0.00          # 0% (비활성화)

[debug]
log_wall_detection = true
log_defense_check = true
log_entry_exit = true